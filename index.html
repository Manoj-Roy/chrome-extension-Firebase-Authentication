<!DOCTYPE html>
<html>

<head>
    <title>Sample Extension</title>
    <meta charset="utf-8">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="./css/style.css">
</head>

<body>
    <div class="container mt-3" style="width: 300px;">
        <!-- sign up -->
        <div id="signUpControle" class="allComponents none">
            <div class="card">
                <div class="card-body">
                    <!-- <form class="needs-validation" novalidate> -->
                    <div class="mb-3 row">
                        <!-- <label for="staticEmail" class="col-sm-2 col-form-label">Email</label> -->
                        <div class="col-sm-12">
                            <input type="text" class="form-control" id="signEmail" value="" placeholder="Email"
                                required>
                            <div class="invalid-feedback">
                                Please select a valid state.
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <!-- <label for="inputPassword" class="col-sm-2 col-form-label">Password</label> -->
                        <div class="col-sm-12">
                            <input type="password" class="form-control" id="signPassword" placeholder="Password"
                                required>
                            <div class="invalid-feedback">
                                Please select a valid state.
                            </div>
                        </div>
                        <div class="col-sm-12 mt-3 d-grid gap-2">
                            <!-- <input type="button" class="form-control" id="signUp" value="Sign Up"> -->
                            <input type="submit" id="signUp" class="btn btn-success" value="Sign Up" />
                            <p class="text-center fw-light" id="isSignUp">Already you are member? <a
                                    style="cursor: pointer;" 
                                    class="text-reset">Log In</a></p>

                        </div>
                    </div>
                    <!-- </form> -->


                </div>
            </div>
        </div>
        <div id="logInControle" class="allComponents none" style="display: block;">
            <div class="card">
                <div class="card-body">
                    <div class="mb-3 row">
                        <!-- <label for="staticEmail" class="col-sm-2 col-form-label">Email</label> -->
                        <div class="col-sm-12">
                            <input type="text" class="form-control" id="loginEmail" value="" placeholder="Email"
                                required>
                            <div class="invalid-feedback">
                                Please select a valid state.
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <!-- <label for="inputPassword" class="col-sm-2 col-form-label">Password</label> -->
                        <div class="col-sm-12">
                            <input type="password" class="form-control" id="loginPassword" placeholder="Password"
                                required>
                            <div class="invalid-feedback">
                                Please select a valid state.
                            </div>
                        </div>
                        <div class="col-sm-12 mt-3 d-grid gap-2">
                            <!-- <input type="button" class="form-control" id="signUp" value="Sign Up"> -->
                            <button type="button" id="logIn" class="btn btn-success">Log In</button>
                            <p class="text-center fw-light" id="islogIn">Don't worry! <a style="cursor: pointer;"
                                     class="text-reset">Sign Up</a></p>
                        </div>
                    </div>

                </div>
            </div>
        </div>
        <div id="homeComponent" class="allComponents none">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between bd-highlight">
                        <div id="user" class="p-2 bd-highlight">I am </div>
                        <!-- <div class="p-2 bd-highlight">Flex item</div> -->
                        <div class="p-2 bd-highlight"><button type="button" class="btn btn-secondary"
                                id="logOut">Logout</button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <h5 class="card-title">Special title treatment</h5>
                    <p class="card-text">With supporting text below as a natural lead-in to additional content.</p>
                </div>
            </div>
        </div>
        <!-- <form action="" id="demo-form"> -->
        <!-- <div class="g-recaptcha" data-sitekey="6LekHWcnAAAAAOj1Q7N0u6Ig_1Qjvdps48lh_H90"></div> -->
        <br />
        <!-- <button class="g-recaptcha" 
                data-sitekey="6Le7LmcnAAAAAAg_L_m9CkzdPQFab0IC46c6zRBn" 
                data-callback='onSubmit' 
                data-action='submit'>Submit</button> -->
        <!-- <input type="submit" value="Submit" id="submit" /> -->
        <!-- </form> -->
    </div>
</body>
<!-- <script src="https://www.google.com/recaptcha/api.js" async defer></script> -->
<!-- <script src="https://www.google.com/recaptcha/api.js"></script> -->
<!-- <script type="module" src="firebase.js"></script> -->
<!-- <script src="https://www.google.com/recaptcha/api.js?render=6Le7LmcnAAAAAAg_L_m9CkzdPQFab0IC46c6zRBn"></script> -->
<!-- <script src="https://www.google.com/recaptcha/api.js?onload=onloadCallback&render=explicit"
    async defer>
</script> -->
<script type="module">
    import * as firebase from "./firebase.js";
    console.log(firebase);
    let fb = firebase.default; // Firebase module
    let signEmail,
        signPassword,
        signUp,
        loginEmail,
        loginPassword,
        logIn,

        logOut,
        token,

        signUpCred,
        logInCred,
        userDetails,
        user,
        isSignUp,
        islogIn;

    signEmail = document.getElementById('signEmail');
    signPassword = document.getElementById('signPassword');
    signUp = document.getElementById('signUp');

    loginEmail = document.getElementById('loginEmail');
    loginPassword = document.getElementById('loginPassword');
    logIn = document.getElementById('logIn');

    logOut = document.getElementById('logOut');

    user = document.getElementById('user');

    isSignUp = document.getElementById('isSignUp');
    islogIn = document.getElementById('islogIn');

    const logIN = async () => {
        // console.log(loginEmail.value,loginPassword.value);

        try {
            logInCred = await fb.signInWithEmailAndPassword(fb.auth, loginEmail.value, loginPassword.value);
            if (logInCred) {
                token = logInCred.user.accessToken;
                localStorage.setItem('setToken', token);
                // console.log(logInCred);
                let parseToken = parseJwt(token);
                user.innerHTML = "Hi this is " + parseToken.email.split("@")[0];
                showComponent('homeComponent');

            }
        } catch (error) {
            error.code.includes('email') ? ((loginEmail.nextElementSibling.innerHTML = error.code), loginEmail.nextElementSibling.style.display = 'block') : (loginEmail.nextElementSibling.style.display = 'none');
            error.code.includes('password') ? ((loginPassword.nextElementSibling.innerHTML = error.code), loginPassword.nextElementSibling.style.display = 'block') : (loginPassword.nextElementSibling.style.display = 'none');
            console.log(error.code);
        }
    }
    const signUP = async () => {

        try {
            signUpCred = await fb.createUserWithEmailAndPassword(fb.auth, signEmail.value, signPassword.value)
            // console.log(signUpCred);
        } catch (error) {
            error.code.includes('email') ? ((signEmail.nextElementSibling.innerHTML = error.code), signEmail.nextElementSibling.style.display = 'block') : (signEmail.nextElementSibling.style.display = 'none');
            error.code.includes('password') ? ((signPassword.nextElementSibling.innerHTML = error.code), signPassword.nextElementSibling.style.display = 'block') : (signPassword.nextElementSibling.style.display = 'none');
            console.log(error.code);
        }
    }
    const logOUT = async () => {
        let out = await fb.signOut(fb.auth);
        setTimeout(() => {
            localStorage.removeItem('setToken');
            showComponent('logInControle');
        })

    }
    const signed = ()=> {
        showComponent('logInControle');
    }
    const logged = ()=> {
        showComponent('signUpControle');
    }
    window.showComponent = function (componentName) {
        console.log(componentName);
        let allComponents = document.querySelectorAll(".allComponents");
        allComponents.forEach((el, i) => {
            el.style.display = 'none';
        })
        let compName = document.getElementById(componentName);
        compName.style.display = 'block';
    }
    logIn.addEventListener("click", logIN);
    signUp.addEventListener("click", signUP);
    logOut.addEventListener("click", logOUT);
    isSignUp.addEventListener("click", signed);
    islogIn.addEventListener("click", logged);

    
    window.getUserDetailsByToken = async () => {
        try {
            userDetails = await fb.getIdTokenResult()
        } catch (error) {
            console.log(error.code);
        }
    }
    window.parseJwt = function (token) {
        var base64Url = token.split('.')[1];
        var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        var jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function (c) {
            return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join(''));

        return JSON.parse(jsonPayload);
    }
    token = localStorage.getItem('setToken');
    if (token) {
        let parseToken = parseJwt(token);
        user.innerHTML = "Hi this is " + parseToken.email.split("@")[0].toUpperCase();
        console.log(parseToken);
        showComponent('homeComponent');
    }
    console.clear()
    // document.getElementById("submit").addEventListener("click", function (e) {
    //     e.preventDefault();
    //     grecaptcha.ready(function () {
    //         grecaptcha.execute('6Le7LmcnAAAAAAg_L_m9CkzdPQFab0IC46c6zRBn', { action: 'submit' }).then(function (token) {
    //             // Add your logic to submit to your backend server here.
    //             console.log(token);
    //         });
    //     });
    // });
</script>

</html>